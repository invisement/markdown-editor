"use strict";(()=>{function D(e,t){for(let[n,o]of Object.entries(t))if(e.startsWith(o+" "))return n;return""}function C(e,t){let n=document.createDocumentFragment();t=t.replaceAll("	","");for(let o of t.split(`

`)){if(o.indexOf(`
`)===-1){n.appendChild(e.createLine({text:o,modif:D(o,e.mods)}));continue}for(let r of o.split(`
`))n.appendChild(e.createLine({text:r,modif:D(r,e.mods)}))}return n}function w(e){function t(i){return i.dataset.list===""?"- ":i.dataset.h1===""?"# ":i.dataset.h2===""?"## ":i.dataset.h3===""?"### ":i.dataset.todoChecked===""?"[x] ":i.dataset.todo===""?"[ ] ":""}let n="",o="",r=i=>i?.dataset.list||i?.dataset.todo;return e.forEach((i,c)=>{o=t(i),n+=o+i.textContent;let f=r(e[c+1])&&r(i),s=e.length-1===c;n+=s?"":f?`
`:`

`}),n}function L(e){let t=e;for(;t?.childNodes.length>0;){let n=Object.values(t.childNodes).reverse(),o=n.filter(r=>r.nodeName==="#text");if(o.length>0)return o[0];t=n[0]}return t}function b(e,t){let n=L(e),o=window.getSelection(),r=document.createRange(),i=n.nodeValue?.length||0;r.setStart(n,t?0:i),r.setEnd(n,t?0:i),o?.removeAllRanges(),o?.addRange(r),o?.collapseToEnd()}var H=[];function T(e,t){let n=e.lines,o=w(n),r=t?n.indexOf(t):0;o!==H[0]?.markdown&&(H.unshift({markdown:o,index:r}),H.length>50&&H.pop())}function I(e){let t;new MutationObserver(()=>{t&&clearTimeout(t)}).observe(e.container,{characterData:!0,subtree:!0}),e.container.addEventListener("keydown",o=>{(o.ctrlKey||o.metaKey)&&o.key==="z"&&(t=window.setTimeout(()=>{J(e)},1))})}function J(e){let{markdown:t,index:n}=H[0]??{};t&&(Object.values(e.container.children).forEach(o=>o.remove()),e.container.appendChild(C(e,t)),setTimeout(()=>{let o=e.container.querySelectorAll("[contenteditable]")[n];o&&(o.focus(),b(o,!1))},0),H.shift(),e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""})))}function j(e,t){let n=e.getSelectedLines();n.length>0&&(t.clipboardData?.setData("text/plain",w(n)),t.preventDefault())}function V(e,t){let n=e.getSelectedLines();n.length>0&&(t.clipboardData?.setData("text/plain",w(n)),t.preventDefault(),e.removeLines(n),T(e,n[n.length-1]))}function F(e,t){t.preventDefault();let n=window.getSelection(),o=n?.getRangeAt(0),r=t.clipboardData?.getData("text")||"";if(D(r,e.mods)!==""){let i=t.target,c=C(e,r),f=c.childElementCount-1,s=e.getLineFromEditable(i),d=e.getSelectedLines();if(d.length>0&&(s=d[d.length-1]),!s?.parentElement?.dataset.pocketEditor)return;e.container.insertBefore(c,e.getNextLine(s));let u=s.nextSibling;for(let p=0;p<f;p++)u&&(u=u.nextSibling);if(u&&b(u),s&&s.textContent===""){let p=l=>{let m=s?.dataset[l]===l,h=e.getNextLine(s)?.dataset[l]===l;return m===h};(s||p("list")||p("todo")||p("todo-checked"))&&s.remove()}e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(n?.rangeCount&&o){let i=n?.anchorOffset??0,c=n.focusNode?.nodeValue??"";c&&n.focusNode?(n.focusNode.nodeValue=c.slice(0,i)+r+c.slice(i),n.collapse(n.focusNode,i+r.length)):(o.insertNode(document.createTextNode(r)),b(o.endContainer))}e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function M(e){let t=document.createElement("div"),n=e.parentElement;if(n)return delete n.dataset.list,delete n.dataset.todo,delete n.dataset.h1,delete n.dataset.h2,delete n.dataset.h3,delete n.dataset.todoChecked,t.textContent=n.textContent,t.setAttribute("contenteditable","true"),Object.values(n.childNodes).forEach(o=>o.remove()),n.appendChild(t),t.focus(),t}function S(e,t,n,o=!0){if(!n)return;let r=e.getLineFromEditable(t);if(!r||r?.dataset[n])return;switch(r.querySelector("span[data-list-marker]")?.remove(),r.querySelector("span[data-todo-marker]")?.remove(),delete r.dataset.h1,delete r.dataset.h2,delete r.dataset.h3,delete r.dataset.list,delete r.dataset.todo,delete r.dataset.todoChecked,n){case"h1":case"h2":case"h3":i(n);break;case"list":f();break;case"todo":c(!1);break;case"todo-checked":c(!0);break}function i(s){let d=document.createElement(s),u=s==="h1"?"#":s==="h2"?"##":"###";d.textContent=t.textContent?.replace(u,"").trimStart()||"",d.setAttribute("contenteditable","true"),r&&(r.dataset[s]="",t.replaceWith(d)),o&&b(d)}function c(s){let d=document.createElement("input"),u=document.createElement("span"),p=document.createElement("p"),l=e.getLineFromEditable(t),m=(t.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,"");!l||l.dataset.todo||((m.startsWith("[ ]")||m.startsWith("[x]"))&&(m=m.slice(4,m.length)),d.type="checkbox",d.name="checkbox",d.setAttribute("aria-label","todo list checkbox"),d.addEventListener("input",()=>{d.checked?(l.setAttribute("data-todo-checked",""),d.setAttribute("checked","")):(l.removeAttribute("data-todo-checked"),l.setAttribute("data-todo",""),d.removeAttribute("checked"))}),s&&(d.setAttribute("checked",""),l.dataset.todoChecked=""),l.dataset.todo="",u.dataset.todoMarker="",p.textContent=m,p.setAttribute("contenteditable","true"),t.replaceWith(p),u.appendChild(d),l.prepend(u),o&&b(p))}function f(){let s=document.createElement("span"),d=document.createElement("p"),u=(t.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,"");!r||r.dataset.list===""||(u.startsWith("-")&&(u=u?.replace("-","").trimStart()),r.dataset.list="",s.dataset.content="\u2022",s.dataset.listMarker="",d.textContent=u,d.setAttribute("contenteditable","true"),t.replaceWith(d),r.prepend(s),o&&b(d))}}function O(e,t){let n=e.container,o=t.target,r;try{let u=o?.hasAttribute("contenteditable"),p=o?.tagName==="INPUT";if(r=window.getSelection()?.getRangeAt(0),!r||!u||p)throw""}catch{return}let i=e.getLineFromEditable(o),c=Object.keys(i?.dataset??{}),f=t?.inputType==="insertParagraph",s=t?.inputType==="insertText",d;if(t.type==="beforeinput"&&f&&i){t.preventDefault(),T(e,i);let u=(o.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,""),p=u.slice(0,r.startOffset),l=u.slice(r.startOffset);if((r.startOffset===0||u===""&&r.startOffset===1)&&c.length>0){M(o);return}i.dataset.todo===""&&(d="todo"),i.dataset.list===""&&(d="list"),i.dataset.todoChecked===""&&(d="todo");let h=e.getNextLine(i),E=e.createLine({text:l,modif:d});h?n.insertBefore(E,h):n?.appendChild(E),E.querySelector("[contenteditable]")?.focus(),o.textContent=p,n.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(t.type==="input"&&s){let p=(o?.textContent??"").replace("\u200B","");for(let[l,m]of Object.entries(e.mods))(p.startsWith(m+" ")||p.startsWith(m+"\xA0"))&&(d=l,S(e,o,d))}}function P(e,t){if(!t.key.includes("Arrow")||!window.getSelection()?.anchorNode)return;let n=t.target,o=e.getLineFromEditable(n),r=window?.getSelection()?.getRangeAt(0),i=r?.startContainer?.nodeValue?.length??0;if(!r||!o)return;let c=e.getPrevLine(o),f=e.getNextLine(o),s=Math.min(r?.endOffset,r?.startOffset)===0,d=Math.max(r?.endOffset,r?.startOffset)===i;if(t.key==="ArrowLeft"&&s&&c)return{line:o,dir:"up"};if(t.key==="ArrowRight"&&d&&f)return{line:o,dir:"down"};let u=!1,p=!1,l=r?.getBoundingClientRect(),m=o?.getBoundingClientRect();if(!m||!l||l.y===0?(u=!0,p=!0):(u=m.top-l.top+l.height>0,p=l.bottom+l.height-m.bottom>0),t.key==="ArrowUp"&&c&&u)return{line:o,dir:"up"};if(t.key==="ArrowDown"&&f&&p)return{line:o,dir:"down"}}function W(e){let t=e.lines,n,o=[-1,-1],r=-1,i=-1;function c(a){clearTimeout(n),n=window.setTimeout(()=>{a()},200)}function f(a){if(a||(a=e.getSelectedLines()),a.length===0)return;document.querySelector("#pocket-editor-mock-sel")?.remove();let g=document.createElement("pre");g.id="pocket-editor-mock-sel",g.textContent="mock-selection",g.setAttribute("contenteditable","true"),e.container.appendChild(g);let v=window.getSelection(),k=document.createRange(),y=g.childNodes[0].nodeValue?.length||0;k.setStart(g.childNodes[0],0),k.setEnd(g.childNodes[0],y),v?.removeAllRanges(),v?.addRange(k)}function s(a){let g=e.getLineFromEditable(a);return g?t.indexOf(g):-1}function d(){let a=t[r];a?.querySelector("[contenteditable]")&&b(a),r=-1,i=-1,o=[-1,-1],document.querySelector("#pocket-editor-mock-sel")?.remove(),e.container.removeEventListener("mousemove",E)}function u(a){a>i&&(o[1]=a),a<i&&(o[0]=a),a===i&&(o=[a,a])}function p(a){i=a,o=[a,a]}function l(a){t.forEach((g,v)=>{v>=a[0]&&v<=a[1]?g.setAttribute("data-selected",""):g.removeAttribute("data-selected")}),c(()=>f())}function m(a){r=i=a,o=[a,a]}function h(a){t=e.lines;let g=e.getSelectedLines(),v=a.key.match(/([x|c|v])/g),k=a.key==="Control"||a.key==="Meta",y=g.length>0,R=a.ctrlKey||a.metaKey;if(k||R&&v&&y)return;if(R&&a.key==="a"){window.getSelection()?.removeAllRanges(),r=i=0,o=[0,t.length-1],l(o),a.preventDefault();return}if(y){if(window.getSelection()?.removeAllRanges(),a.key==="Escape"||a.key==="Tab"){d(),l(o),a.preventDefault();return}if(a.key.includes("Arrow")){a.key.includes("Down")&&(r=Math.min(r+1,t.length-1)),a.key.includes("Up")&&(r=Math.max(0,r-1)),a.shiftKey&&u(r),a.shiftKey||p(r),l(o),a.preventDefault();return}a.code.match(/Shift|Alt|Control|Caps/)||(d(),T(e,g[g.length- -1]),e.removeLines(g),a.code==="Enter"&&a.preventDefault())}if(!a.shiftKey)return;let{line:q}=P(e,a)??{};if(q){let Z=t.indexOf(q);m(Z),l(o),window.getSelection()?.removeAllRanges()}}function E(a){let g=a.target,v=e.getSelectedLines();v.length>0&&window.getSelection()?.removeAllRanges();let k=g.getAttribute("aria-label")==="todo list checkbox",y=g.dataset.listMarker,R=!!g.getAttribute("contenteditable");if(k||y||R){if(r=s(g),r===i&&v.length===0)return;u(r),l(o)}}function x(a){let g=a.target,v=a.button===2,k=a.button===0,y=e.getSelectedLines().length>0;t=e.lines,v&&a.preventDefault(),k&&(y&&(d(),l(o)),g.getAttribute("contenteditable")&&(m(s(g)),e.container.addEventListener("mousemove",E)))}function A(a){!a.composedPath().includes(e.container)&&(t=e.lines,d(),l(o)),e.container.removeEventListener("mousemove",E)}window.addEventListener("touchend",A),window.addEventListener("click",A),e.container.addEventListener("keydown",h),e.container.addEventListener("mousedown",x)}function z(e,t){b(t),e.parentElement?.remove()}function Y(e,t){let n=L(t),o=n.nodeType===3,r=n.nodeValue?.length||0,i=e?.textContent||"";n[o?"nodeValue":"textContent"]+=i;let c=window.getSelection(),f=document.createRange();f.setStart(n,o?r:0),f.setEnd(n,o?r:0),c?.removeAllRanges(),c?.addRange(f),e.parentElement.remove()}function _(e){let t="ontouchstart"in window||navigator.maxTouchPoints>0,n=navigator.userAgent.toLowerCase(),o=window.getSelection();function r(i){let c=i.target,f=e.getLineFromEditable(c),s="ontouchstart"in window||navigator.maxTouchPoints>0,d=!!c.getAttribute("contenteditable"),u=o?.getRangeAt(0)?.endOffset===0,p=i.inputType==="deleteContentBackward";if(i.type==="beforeinput"&&!p||!u||!d)return;if(i.preventDefault(),f&&T(e,f),Object.keys(f?.dataset??{}).length>0){let h=M(c);s&&h&&h.textContent===""&&(h.textContent=e.ZERO_WIDTH_WHITESPACE,b(h));return}let m=e.getPrevLine(f);m&&(c.textContent===""&&z(c,m),c.textContent!==""&&Y(c,m))}if(e.container.addEventListener("beforeinput",r),n.includes("safari")&&!n.match(/chrome|chromium/)&&e.container.addEventListener("keydown",i=>{try{let c=o?.getRangeAt(0),f=i.key==="Backspace",s=c?.startOffset===0;f&&s&&r(i)}catch{}}),t){let i=!1;e.container.addEventListener("beforeinput",c=>{let f=c.target,s=c.inputType==="deleteContentBackward",d=f.textContent===e.ZERO_WIDTH_WHITESPACE;s&&d&&(i=!0)}),e.container.addEventListener("keyup",c=>{let f=c.target;if(i){i=!1,r(c);return}f.textContent===""&&(f.textContent=e.ZERO_WIDTH_WHITESPACE,b(f))})}}function K(e){let t=0;function n(){let i=document.createElement("p"),c=document.createElement("span");i.id="pocket-editor-mock-p",c.textContent="abcdefghijklmnopqrstuvwxyz0123456789",i?.appendChild(c),e.container.querySelector(".line [contenteditable]")?.appendChild(i),t=c.offsetWidth/36/2,i.remove()}function o(i,c){let f=window.getSelection(),s=-1,d=U(f,i),u=e.caret_x??d.offset,p=i?.querySelector("[contenteditable]"),l=L(p),m=document.createRange();m.setStart(l,0),m.setEnd(l,0);let h=0;for(let E=0;E<c.length-1;E++){try{m.setStart(l,E),m.setEnd(l,E)}catch{break}if(h=m.getBoundingClientRect().x-d.editable,h+t>=u){s=E;break}}return s}function r(i){let c=i?.querySelector("[contenteditable]");if(!c)return console.warn("Couldn't get string[], no contenteditable found"),[];let f=0,s=0,d=0,u=[""],p=(c.textContent??"").split(" "),l=L(c),m=document.createRange();m.setStart(l,0),m.setEnd(l,0);let h=navigator.userAgent.includes("AppleWebKit");d=s=m.getBoundingClientRect().y;for(let E of p){E=E+" ",f+=E.length;try{m.setStart(l,f),m.setEnd(l,f),s=m.getBoundingClientRect().y}catch{}h&&(u[0]+=E),s>d&&(h&&(u[0]=u[0].trimEnd()),u.unshift(""),d=s),h===!1&&(u[0]+=E)}return u.reverse(),u}e.container.addEventListener("pointerdown",function(){e.caret_x=void 0}),e.container.addEventListener("keydown",function(i){if(!i.key.includes("Arrow"))return;let c=i.key==="ArrowRight",f=i.key==="ArrowLeft",{line:s,dir:d}=P(e,i)??{},u=window.getSelection(),p=document.createRange(),l=0,m;if(f||c?e.caret_x=void 0:e.caret_x===void 0&&(e.caret_x=U(u,s).offset),!!s){if(t===0&&n(),d==="down"){let h=e.getNextLine(s)??s;m=L(h);let E=m.nodeValue?.length||0;if(!c){let x=r(h);l=o(h,x[0])??-1,l<0&&(l=E)}}if(d==="up"){let h=e.getPrevLine(s)??s;m=L(h);let E=m.nodeValue?.length||0;if(l=E,!f){let x=r(h),A=x[x.length-1].trimEnd(),a=o(h,A)??E;l=E-(A.length-a),a<0&&(l=E)}}try{p.setStart(m,l),p.setEnd(m,l),u?.removeAllRanges(),u?.addRange(p),u?.collapseToEnd(),i.preventDefault()}catch{console.warn("Cannot set caret")}}})}function U(e,t){let n=!e?.anchorNode;if(!t||n)return{editable:0,range:0,offset:0};let r=t.querySelector("[contenteditable]")?.getBoundingClientRect().x??0,i=e?.getRangeAt(0)?.cloneRange()?.getBoundingClientRect().x??0;return{editable:r,range:i,offset:i-r}}async function B(e,t){let n=t.target,r=(t.ctrlKey||t.metaKey)&&t.shiftKey&&t.code.includes("Digit"),i=e.getLineFromEditable(n);if(r&&n){let c=parseInt(t.code.replace("Digit",""))-1,s=Object.keys(e.mods)[c];if(i?.hasAttribute(`data-${s}`)||c===5){t.preventDefault(),M(n);return}s in e.mods&&s!=="todo-checked"&&(t.preventDefault(),S(e,n,s))}}var N=class{container;lines;wrapper;caret_x;ZERO_WIDTH_WHITESPACE="\u200B";mods={h1:"#",h2:"##",h3:"###",list:"-",todo:"[ ]","todo-checked":"[x]"};constructor(t,n){let{text:o,defer:r,id:i}=n??{};if(this.wrapper=document.querySelector(selector),this.container=t,this.lines=[],this.wrapper===null)throw`Pocket editor: selector "${selector}" was not found`;i&&(t.id=i),t.dataset.pocketEditor="",typeof r=="number"?setTimeout(()=>this.init(o),r):r===!0?setTimeout(()=>this.init(o)):this.init(o)}init(t){let n=this;t?this.container.appendChild(C(this,t)):this.container.appendChild(this.createLine({text:""})),this.wrapper&&this.wrapper.appendChild(this.container),this.container.addEventListener("beforeinput",i=>O(n,i)),this.container.addEventListener("input",i=>O(n,i)),this.container.addEventListener("keydown",i=>B(n,i)),this.container.addEventListener("paste",i=>F(n,i)),this.container.addEventListener("copy",i=>j(n,i)),this.container.addEventListener("cut",i=>V(n,i)),W(n),K(n),_(n),I(n);let o=()=>{this.lines=Object.values(this.container.children)};new MutationObserver(o).observe(this.container,{childList:!0}),this.lines=Object.values(this.container.children)}get value(){return w(this.lines)}set value(t){Object.values(this.container.children).forEach(n=>n.remove()),this.container.appendChild(C(this,t))}oninput(t){let n=this;return this.container.addEventListener("cut",o),this.container.addEventListener("paste",o),this.container.addEventListener("input",o),this.container.addEventListener("beforeinput",o),()=>{this.container.removeEventListener("cut",o),this.container.removeEventListener("paste",o),this.container.removeEventListener("input",o),this.container.removeEventListener("beforeinput",o)};function o(r){r.type==="beforeinput"&&!r.inputType.match(/(deleteContentBackward|insertParagraph)/g)||t(n.value)}}addEventListener(t,n){return this.oninput(n)}getSelectedLines(){return this.lines.filter(t=>t.dataset.selected!==void 0)??[]}getPrevLine(t){return this.lines[this.lines.indexOf(t)-1]}getNextLine(t){return this.lines[this.lines.indexOf(t)+1]}getLineFromEditable(t){for(;t?.parentElement;){let n=t.parentElement;if(n.tagName==="DIV")return n;t=n}return null}removeLines(t){let n=this.createLine(),o=this.getPrevLine(t[0]);t.forEach(r=>r.remove()),o?this.insertAfter(n,o):this.container.prepend(n),b(n),this.container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}createLine(t){let n=document.createElement("div"),o=document.createElement("p"),r=t?.modif??"",i=this.mods;return o.setAttribute("contenteditable","true"),n.appendChild(o),typeof t?.text=="string"&&(o.textContent=t.text),r in i&&S(this,o,r,!1),n}insertAfter(t,n){n?.parentNode?.insertBefore(t,n.nextSibling)}},Bt=N;globalThis.PocketEditor=N;})();

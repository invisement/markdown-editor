"use strict";(()=>{function D(o,t){for(let[e,n]of Object.entries(t))if(o.startsWith(n+" "))return e;return""}function w(o,t){let e=document.createDocumentFragment();t=t.replaceAll("	","");for(let n of t.split(`

`)){if(n.indexOf(`
`)===-1){e.appendChild(o.createLine({text:n,modif:D(n,o.mods)}));continue}for(let r of n.split(`
`))e.appendChild(o.createLine({text:r,modif:D(r,o.mods)}))}return e}function C(o){function t(i){return i.dataset.list===""?"- ":i.dataset.h1===""?"# ":i.dataset.h2===""?"## ":i.dataset.h3===""?"### ":i.dataset.todoChecked===""?"[x] ":i.dataset.todo===""?"[ ] ":""}let e="",n="",r=i=>i?.dataset.list||i?.dataset.todo;return o.forEach((i,s)=>{n=t(i),e+=n+i.textContent;let m=r(o[s+1])&&r(i),d=o.length-1===s;e+=d?"":m?`
`:`

`}),e}function L(o){let t=o;for(;t?.childNodes.length>0;){let e=Object.values(t.childNodes).reverse(),n=e.filter(r=>r.nodeName==="#text");if(n.length>0)return n[0];t=e[0]}return t}function b(o,t){let e=L(o),n=window.getSelection(),r=document.createRange(),i=e.nodeValue?.length||0;r.setStart(e,t?0:i),r.setEnd(e,t?0:i),n?.removeAllRanges(),n?.addRange(r),n?.collapseToEnd()}var A=[];function x(o,t){let e=o.lines,n=C(e),r=t?e.indexOf(t):0;n!==A[0]?.markdown&&(A.unshift({markdown:n,index:r}),A.length>50&&A.pop())}function I(o){let t;new MutationObserver(()=>{t&&clearTimeout(t)}).observe(o.container,{characterData:!0,subtree:!0}),o.container.addEventListener("keydown",n=>{(n.ctrlKey||n.metaKey)&&n.key==="z"&&(t=window.setTimeout(()=>{z(o)},1))})}function z(o){let{markdown:t,index:e}=A[0]??{};t&&(Object.values(o.container.children).forEach(n=>n.remove()),o.container.appendChild(w(o,t)),setTimeout(()=>{let n=o.container.querySelectorAll("[contenteditable]")[e];n&&(n.focus(),b(n,!1))},0),A.shift(),o.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""})))}function V(o,t){let e=o.getSelectedLines();e.length>0&&(t.clipboardData?.setData("text/plain",C(e)),t.preventDefault())}function U(o,t){let e=o.getSelectedLines();e.length>0&&(t.clipboardData?.setData("text/plain",C(e)),t.preventDefault(),o.removeLines(e),x(o,e[e.length-1]))}function F(o,t){t.preventDefault();let e=window.getSelection(),n=e?.getRangeAt(0),r=t.clipboardData?.getData("text")||"";if(D(r,o.mods)!==""){let i=t.target,s=w(o,r),m=s.childElementCount-1,d=o.getLineFromEditable(i),l=o.getSelectedLines();if(l.length>0&&(d=l[l.length-1]),!d?.parentElement?.dataset.pocketEditor)return;o.container.insertBefore(s,o.getNextLine(d));let u=d.nextSibling;for(let p=0;p<m;p++)u&&(u=u.nextSibling);if(u&&b(u),d&&d.textContent===""){let p=c=>{let f=d?.dataset[c]===c,g=o.getNextLine(d)?.dataset[c]===c;return f===g};(d||p("list")||p("todo")||p("todo-checked"))&&d.remove()}o.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(e?.rangeCount&&n){let i=e?.anchorOffset??0,s=e.focusNode?.nodeValue??"";s&&e.focusNode?(e.focusNode.nodeValue=s.slice(0,i)+r+s.slice(i),e.collapse(e.focusNode,i+r.length)):(n.insertNode(document.createTextNode(r)),b(n.endContainer))}o.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function T(o){let t=document.createElement("div"),e=o.parentElement;if(e)return delete e.dataset.list,delete e.dataset.todo,delete e.dataset.h1,delete e.dataset.h2,delete e.dataset.h3,delete e.dataset.todoChecked,t.textContent=e.textContent,t.setAttribute("contenteditable","true"),Object.values(e.childNodes).forEach(n=>n.remove()),e.appendChild(t),t.focus(),t}function M(o,t,e,n=!0){if(!e)return;let r=o.getLineFromEditable(t);if(!r||r?.dataset[e])return;switch(r.querySelector("span[data-list-marker]")?.remove(),r.querySelector("span[data-todo-marker]")?.remove(),e){case"h1":case"h2":case"h3":i(e);break;case"list":m();break;case"todo":s(!1);break;case"todo-checked":s(!0);break}function i(d){let l=document.createElement(d),u=d==="h1"?"#":d==="h2"?"##":"###";l.textContent=t.textContent?.replace(u,"").trimStart()||"",l.setAttribute("contenteditable","true"),r&&(r.dataset[d]="",t.replaceWith(l)),n&&b(l)}function s(d){let l=document.createElement("input"),u=document.createElement("span"),p=document.createElement("p"),c=o.getLineFromEditable(t),f=t.textContent??"";!c||c.dataset.todo||((f.startsWith("[ ]")||f.startsWith("[x]"))&&(f=f.slice(4,f.length)),l.type="checkbox",l.name="checkbox",l.setAttribute("aria-label","todo list checkbox"),l.addEventListener("input",()=>{l.checked?(c.setAttribute("data-todo-checked",""),l.setAttribute("checked","")):(c.removeAttribute("data-todo-checked"),c.setAttribute("data-todo",""),l.removeAttribute("checked"))}),d&&(l.setAttribute("checked",""),c.dataset.todoChecked=""),c.dataset.todo="",u.dataset.todoMarker="",p.textContent=f,p.setAttribute("contenteditable","true"),t.replaceWith(p),u.appendChild(l),c.prepend(u),n&&b(p))}function m(){let d=document.createElement("span"),l=document.createElement("p"),u=t.textContent??"";!r||r.dataset.list===""||(u.startsWith("-")&&(u=u?.replace("-","").trimStart()),r.dataset.list="",d.dataset.content="\u2022",d.dataset.listMarker="",l.textContent=u,l.setAttribute("contenteditable","true"),t.replaceWith(l),r.prepend(d),n&&b(l))}}function N(o,t){let e=o.container,n=t.target,r;try{let u=n?.hasAttribute("contenteditable"),p=n?.tagName==="INPUT";if(r=window.getSelection()?.getRangeAt(0),!r||!u||p)throw""}catch{return}let i=o.getLineFromEditable(n),s=Object.keys(i?.dataset??{}),m=t?.inputType==="insertParagraph",d=t?.inputType==="insertText",l;if(t.type==="beforeinput"&&m&&i){t.preventDefault(),x(o,i);let u=(n.textContent??"").slice(0,r.startOffset),p=(n.textContent??"").slice(r.startOffset);if(r.startOffset===0&&s.length>0){T(n);return}i.dataset.todo===""&&(l="todo"),i.dataset.list===""&&(l="list"),i.dataset.todoChecked===""&&(l="todo");let c=o.getNextLine(i),f=o.createLine({text:p,modif:l});c?e.insertBefore(f,c):e?.appendChild(f),f.querySelector("[contenteditable]")?.focus(),n.textContent=u,e.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(t.type==="input"&&d){let p=(n?.textContent??"").replace("\u200B","");for(let[c,f]of Object.entries(o.mods))(p.startsWith(f+" ")||p.startsWith(f+"\xA0"))&&(l=c,M(o,n,l))}}function P(o,t){if(!t.key.includes("Arrow")||!window.getSelection()?.anchorNode)return;let e=t.target,n=o.getLineFromEditable(e),r=window?.getSelection()?.getRangeAt(0),i=r?.startContainer?.nodeValue?.length??0;if(!r||!n)return;let s=o.getPrevLine(n),m=o.getNextLine(n),d=Math.min(r?.endOffset,r?.startOffset)===0,l=Math.max(r?.endOffset,r?.startOffset)===i;if(t.key==="ArrowLeft"&&d&&s)return{line:n,dir:"up"};if(t.key==="ArrowRight"&&l&&m)return{line:n,dir:"down"};let u=!1,p=!1,c=r?.getBoundingClientRect(),f=n?.getBoundingClientRect();if(!f||!c||c.y===0?(u=!0,p=!0):(u=f.top-c.top+c.height>0,p=c.bottom+c.height-f.bottom>0),t.key==="ArrowUp"&&s&&u)return{line:n,dir:"up"};if(t.key==="ArrowDown"&&m&&p)return{line:n,dir:"down"}}function W(o){let t=o.lines,e,n=[-1,-1],r=-1,i=-1;function s(a){clearTimeout(e),e=window.setTimeout(()=>{a()},200)}function m(a){if(a||(a=o.getSelectedLines()),a.length===0)return;document.querySelector("#pocket-editor-mock-sel")?.remove();let h=document.createElement("pre");h.id="pocket-editor-mock-sel",h.textContent="mock-selection",h.setAttribute("contenteditable","true"),o.container.appendChild(h);let v=window.getSelection(),y=document.createRange(),S=h.childNodes[0].nodeValue?.length||0;y.setStart(h.childNodes[0],0),y.setEnd(h.childNodes[0],S),v?.removeAllRanges(),v?.addRange(y)}function d(a){let h=o.getLineFromEditable(a);return h?t.indexOf(h):-1}function l(){let a=t[r];a?.querySelector("[contenteditable]")&&b(a),r=-1,i=-1,n=[-1,-1],document.querySelector("#pocket-editor-mock-sel")?.remove(),o.container.removeEventListener("mousemove",E)}function u(a){a>i&&(n[1]=a),a<i&&(n[0]=a),a===i&&(n=[a,a])}function p(a){i=a,n=[a,a]}function c(a){t.forEach((h,v)=>{v>=a[0]&&v<=a[1]?h.setAttribute("data-selected",""):h.removeAttribute("data-selected")}),s(()=>m())}function f(a){r=i=a,n=[a,a]}function g(a){t=o.lines;let h=o.getSelectedLines(),v=a.key.match(/([x|c|v])/g),y=a.key==="Control"||a.key==="Meta",S=h.length>0,R=a.ctrlKey||a.metaKey;if(y||R&&v&&S)return;if(R&&a.key==="a"){window.getSelection()?.removeAllRanges(),r=i=0,n=[0,t.length-1],c(n),a.preventDefault();return}if(S){if(window.getSelection()?.removeAllRanges(),a.key==="Escape"||a.key==="Tab"){l(),c(n),a.preventDefault();return}if(a.key.includes("Arrow")){a.key.includes("Down")&&(r=Math.min(r+1,t.length-1)),a.key.includes("Up")&&(r=Math.max(0,r-1)),a.shiftKey&&u(r),a.shiftKey||p(r),c(n),a.preventDefault();return}a.code.match(/Shift|Alt|Control|Caps/)||(l(),x(o,h[h.length- -1]),o.removeLines(h),a.code==="Enter"&&a.preventDefault())}if(!a.shiftKey)return;let{line:j}=P(o,a)??{};if(j){let Z=t.indexOf(j);f(Z),c(n),window.getSelection()?.removeAllRanges()}}function E(a){let h=a.target,v=o.getSelectedLines();v.length>0&&window.getSelection()?.removeAllRanges();let y=h.getAttribute("aria-label")==="todo list checkbox",S=h.dataset.listMarker,R=!!h.getAttribute("contenteditable");if(y||S||R){if(r=d(h),r===i&&v.length===0)return;u(r),c(n)}}function k(a){let h=a.target;t=o.lines,a.button===2&&a.preventDefault(),a.button===0&&(l(),c(n),h.getAttribute("contenteditable")&&(f(d(h)),o.container.addEventListener("mousemove",E)))}function H(a){!a.composedPath().includes(o.container)&&(t=o.lines,l(),c(n)),o.container.removeEventListener("mousemove",E)}window.addEventListener("touchend",H),window.addEventListener("click",H),o.container.addEventListener("keydown",g),o.container.addEventListener("mousedown",k)}var K="\u200B";function Y(o,t){b(t),o.parentElement?.remove()}function X(o,t){let e=L(t),n=e.nodeType===3,r=e.nodeValue?.length||0,i=o?.textContent||"";e[n?"nodeValue":"textContent"]+=i;let s=window.getSelection(),m=document.createRange();m.setStart(e,n?r:0),m.setEnd(e,n?r:0),s?.removeAllRanges(),s?.addRange(m),o.parentElement.remove()}function _(o){let t="ontouchstart"in window||navigator.maxTouchPoints>0,e=navigator.userAgent.toLowerCase(),n=window.getSelection();function r(i){let s=i.target,m=o.getLineFromEditable(s),d="ontouchstart"in window||navigator.maxTouchPoints>0,l=!!s.getAttribute("contenteditable"),u=n?.getRangeAt(0)?.endOffset===0,p=i.inputType==="deleteContentBackward";if(i.type==="beforeinput"&&!p||!u||!l)return;if(i.preventDefault(),m&&x(o,m),Object.keys(m?.dataset??{}).length>0){let g=T(s);d&&g&&g.textContent===""&&(g.textContent=K,b(g));return}let f=o.getPrevLine(m);f&&(s.textContent===""&&Y(s,f),s.textContent!==""&&X(s,f))}if(o.container.addEventListener("beforeinput",r),e.includes("safari")&&!e.match(/chrome|chromium/)&&o.container.addEventListener("keydown",i=>{try{let s=n?.getRangeAt(0),m=i.key==="Backspace",d=s?.startOffset===0;m&&d&&r(i)}catch{}}),t){let i=!1;o.container.addEventListener("beforeinput",s=>{let m=s.target,d=s.inputType==="deleteContentBackward",l=m.textContent===K;d&&l&&(i=!0)}),o.container.addEventListener("keyup",s=>{let m=s.target;if(i){i=!1,r(s);return}m.textContent===""&&(m.textContent=K,b(m))})}}function B(o){let t=0;function e(){let i=document.createElement("p"),s=document.createElement("span");i.id="pocket-editor-mock-p",s.textContent="abcdefghijklmnopqrstuvwxyz0123456789",i?.appendChild(s),o.container.querySelector(".line [contenteditable]")?.appendChild(i),t=s.offsetWidth/36/2,i.remove()}function n(i,s){let m=window.getSelection(),d=-1,l=J(m,i),u=o.caret_x??l.offset,p=i?.querySelector("[contenteditable]"),c=L(p),f=document.createRange();f.setStart(c,0),f.setEnd(c,0);let g=0;for(let E=0;E<s.length-1;E++){try{f.setStart(c,E),f.setEnd(c,E)}catch{break}if(g=f.getBoundingClientRect().x-l.editable,g+t>=u){d=E;break}}return d}function r(i){let s=i?.querySelector("[contenteditable]");if(!s)return console.warn("Couldn't get string[], no contenteditable found"),[];let m=0,d=0,l=0,u=[""],p=(s.textContent??"").split(" "),c=L(s),f=document.createRange();f.setStart(c,0),f.setEnd(c,0);let g=navigator.userAgent.includes("AppleWebKit");l=d=f.getBoundingClientRect().y;for(let E of p){E=E+" ",m+=E.length;try{f.setStart(c,m),f.setEnd(c,m),d=f.getBoundingClientRect().y}catch{}g&&(u[0]+=E),d>l&&(g&&(u[0]=u[0].trimEnd()),u.unshift(""),l=d),g===!1&&(u[0]+=E)}return u.reverse(),u}o.container.addEventListener("pointerdown",function(){o.caret_x=void 0}),o.container.addEventListener("keydown",function(i){if(!i.key.includes("Arrow"))return;let s=i.key==="ArrowRight",m=i.key==="ArrowLeft",{line:d,dir:l}=P(o,i)??{},u=window.getSelection(),p=document.createRange(),c=0,f;if(m||s?o.caret_x=void 0:o.caret_x===void 0&&(o.caret_x=J(u,d).offset),!!d){if(t===0&&e(),l==="down"){let g=o.getNextLine(d)??d;f=L(g);let E=f.nodeValue?.length||0;if(!s){let k=r(g);c=n(g,k[0])??-1,c<0&&(c=E)}}if(l==="up"){let g=o.getPrevLine(d)??d;f=L(g);let E=f.nodeValue?.length||0;if(c=E,!m){let k=r(g),H=k[k.length-1].trimEnd(),a=n(g,H)??E;c=E-(H.length-a),a<0&&(c=E)}}try{p.setStart(f,c),p.setEnd(f,c),u?.removeAllRanges(),u?.addRange(p),u?.collapseToEnd(),i.preventDefault()}catch{console.warn("Cannot set caret")}}})}function J(o,t){let n=t?.querySelector("[contenteditable]")?.getBoundingClientRect().x??0,r=o?.getRangeAt(0)?.cloneRange()?.getBoundingClientRect().x??0;return{editable:n,range:r,offset:r-n}}async function q(o,t){let e=t.target;if((t.ctrlKey||t.metaKey)&&t.shiftKey&&t.code.includes("Digit")&&e){let i=parseInt(t.code.replace("Digit",""))-1,s=Object.keys(o.mods)[i];if(i===5){t.preventDefault(),T(e);return}s in o.mods&&s!=="todo-checked"&&(t.preventDefault(),M(o,e,s))}}var O=class{container;lines;wrapper;caret_x;mods={h1:"#",h2:"##",h3:"###",list:"-",todo:"[ ]","todo-checked":"[x]"};constructor(t,e){let n=document.createElement("div"),{text:r,defer:i,id:s}=e??{};if(this.wrapper=document.querySelector(t),this.container=n,this.lines=[],this.wrapper===null)throw`Pocket editor: selector "${t}" was not found`;s&&(n.id=s),n.dataset.pocketEditor="",typeof i=="number"?setTimeout(()=>this.init(r),i):i===!0?setTimeout(()=>this.init(r)):this.init(r)}init(t){let e=this;t?this.container.appendChild(w(this,t)):this.container.appendChild(this.createLine({text:""})),this.wrapper&&this.wrapper.appendChild(this.container),this.container.addEventListener("beforeinput",i=>N(e,i)),this.container.addEventListener("input",i=>N(e,i)),this.container.addEventListener("keydown",i=>q(e,i)),this.container.addEventListener("paste",i=>F(e,i)),this.container.addEventListener("copy",i=>V(e,i)),this.container.addEventListener("cut",i=>U(e,i)),W(e),B(e),_(e),I(e);let n=()=>{this.lines=Object.values(this.container.children)};new MutationObserver(n).observe(this.container,{childList:!0}),this.lines=Object.values(this.container.children)}get value(){return C(this.lines)}set value(t){Object.values(this.container.children).forEach(e=>e.remove()),this.container.appendChild(w(this,t))}oninput(t){let e=this;return this.container.addEventListener("cut",n),this.container.addEventListener("paste",n),this.container.addEventListener("input",n),this.container.addEventListener("beforeinput",n),()=>{this.container.removeEventListener("cut",n),this.container.removeEventListener("paste",n),this.container.removeEventListener("input",n),this.container.removeEventListener("beforeinput",n)};function n(r){r.type==="beforeinput"&&!r.inputType.match(/(deleteContentBackward|insertParagraph)/g)||t(e.value)}}addEventListener(t,e){return this.oninput(e)}getSelectedLines(){return this.lines.filter(t=>t.dataset.selected!==void 0)??[]}getPrevLine(t){return this.lines[this.lines.indexOf(t)-1]}getNextLine(t){return this.lines[this.lines.indexOf(t)+1]}getLineFromEditable(t){for(;t?.parentElement;){let e=t.parentElement;if(e.tagName==="DIV")return e;t=e}return null}removeLines(t){let e=this.createLine(),n=this.getPrevLine(t[0]);t.forEach(r=>r.remove()),n?this.insertAfter(e,n):this.container.prepend(e),b(e),this.container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}createLine(t){let e=document.createElement("div"),n=document.createElement("p"),r=t?.modif??"",i=this.mods;return n.setAttribute("contenteditable","true"),e.appendChild(n),typeof t?.text=="string"&&(n.textContent=t.text),r in i&&M(this,n,r,!1),e}insertAfter(t,e){e?.parentNode?.insertBefore(t,e.nextSibling)}},qt=O;globalThis.PocketEditor=O;})();

"use strict";(()=>{function D(n,t){for(let[e,o]of Object.entries(t))if(n.startsWith(o+" "))return e;return""}function C(n,t){let e=document.createDocumentFragment();t=t.replaceAll("	","");for(let o of t.split(`

`)){if(o.indexOf(`
`)===-1){e.appendChild(n.createLine({text:o,modif:D(o,n.mods)}));continue}for(let r of o.split(`
`))e.appendChild(n.createLine({text:r,modif:D(r,n.mods)}))}return e}function T(n){function t(i){return i.dataset.list===""?"- ":i.dataset.h1===""?"# ":i.dataset.h2===""?"## ":i.dataset.h3===""?"### ":i.dataset.todoChecked===""?"[x] ":i.dataset.todo===""?"[ ] ":""}let e="",o="",r=i=>i?.dataset.list||i?.dataset.todo;return n.forEach((i,s)=>{o=t(i),e+=o+i.textContent;let m=r(n[s+1])&&r(i),d=n.length-1===s;e+=d?"":m?`
`:`

`}),e}function k(n){let t=n;for(;t?.childNodes.length>0;){let e=Object.values(t.childNodes).reverse(),o=e.filter(r=>r.nodeName==="#text");if(o.length>0)return o[0];t=e[0]}return t}function b(n,t){let e=k(n),o=window.getSelection(),r=document.createRange(),i=e.nodeValue?.length||0;r.setStart(e,t?0:i),r.setEnd(e,t?0:i),o?.removeAllRanges(),o?.addRange(r),o?.collapseToEnd()}var A=[];function w(n,t){let e=n.lines,o=T(e),r=t?e.indexOf(t):0;o!==A[0]?.markdown&&(A.unshift({markdown:o,index:r}),A.length>50&&A.pop())}function I(n){let t;new MutationObserver(()=>{t&&clearTimeout(t)}).observe(n.container,{characterData:!0,subtree:!0}),n.container.addEventListener("keydown",o=>{(o.ctrlKey||o.metaKey)&&o.key==="z"&&(t=window.setTimeout(()=>{z(n)},1))})}function z(n){let{markdown:t,index:e}=A[0]??{};t&&(Object.values(n.container.children).forEach(o=>o.remove()),n.container.appendChild(C(n,t)),setTimeout(()=>{let o=n.container.querySelectorAll("[contenteditable]")[e];o&&(o.focus(),b(o,!1))},0),A.shift(),n.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""})))}function V(n,t){let e=n.getSelectedLines();e.length>0&&(t.clipboardData?.setData("text/plain",T(e)),t.preventDefault())}function U(n,t){let e=n.getSelectedLines();e.length>0&&(t.clipboardData?.setData("text/plain",T(e)),t.preventDefault(),n.removeLines(e),w(n,e[e.length-1]))}function F(n,t){t.preventDefault();let e=window.getSelection(),o=e?.getRangeAt(0),r=t.clipboardData?.getData("text")||"";if(D(r,n.mods)!==""){let i=t.target,s=C(n,r),m=s.childElementCount-1,d=n.getLineFromEditable(i),l=n.getSelectedLines();if(l.length>0&&(d=l[l.length-1]),!d?.parentElement?.dataset.pocketEditor)return;n.container.insertBefore(s,n.getNextLine(d));let u=d.nextSibling;for(let p=0;p<m;p++)u&&(u=u.nextSibling);if(u&&b(u),d&&d.textContent===""){let p=c=>{let f=d?.dataset[c]===c,g=n.getNextLine(d)?.dataset[c]===c;return f===g};(d||p("list")||p("todo")||p("todo-checked"))&&d.remove()}n.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(e?.rangeCount&&o){let i=e?.anchorOffset??0,s=e.focusNode?.nodeValue??"";s&&e.focusNode?(e.focusNode.nodeValue=s.slice(0,i)+r+s.slice(i),e.collapse(e.focusNode,i+r.length)):(o.insertNode(document.createTextNode(r)),b(o.endContainer))}n.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function M(n){let t=document.createElement("div"),e=n.parentElement;if(e)return delete e.dataset.list,delete e.dataset.todo,delete e.dataset.h1,delete e.dataset.h2,delete e.dataset.h3,delete e.dataset.todoChecked,t.textContent=e.textContent,t.setAttribute("contenteditable","true"),Object.values(e.childNodes).forEach(o=>o.remove()),e.appendChild(t),t.focus(),t}function S(n,t,e,o=!0){if(!e)return;let r=n.getLineFromEditable(t);if(!r||r?.dataset[e])return;switch(r.querySelector("span[data-list-marker]")?.remove(),r.querySelector("span[data-todo-marker]")?.remove(),e){case"h1":case"h2":case"h3":i(e);break;case"list":m();break;case"todo":s(!1);break;case"todo-checked":s(!0);break}function i(d){let l=document.createElement(d),u=d==="h1"?"#":d==="h2"?"##":"###";l.textContent=t.textContent?.replace(u,"").trimStart()||"",l.setAttribute("contenteditable","true"),r&&(r.dataset[d]="",t.replaceWith(l)),o&&b(l)}function s(d){let l=document.createElement("input"),u=document.createElement("span"),p=document.createElement("p"),c=n.getLineFromEditable(t),f=t.textContent??"";!c||c.dataset.todo||((f.startsWith("[ ]")||f.startsWith("[x]"))&&(f=f.slice(4,f.length)),l.type="checkbox",l.name="checkbox",l.setAttribute("aria-label","todo list checkbox"),l.addEventListener("input",()=>{l.checked?(c.setAttribute("data-todo-checked",""),l.setAttribute("checked","")):(c.removeAttribute("data-todo-checked"),c.setAttribute("data-todo",""),l.removeAttribute("checked"))}),d&&(l.setAttribute("checked",""),c.dataset.todoChecked=""),c.dataset.todo="",u.dataset.todoMarker="",p.textContent=f,p.setAttribute("contenteditable","true"),t.replaceWith(p),u.appendChild(l),c.prepend(u),o&&b(p))}function m(){let d=document.createElement("span"),l=document.createElement("p"),u=t.textContent??"";!r||r.dataset.list===""||(u.startsWith("-")&&(u=u?.replace("-","").trimStart()),r.dataset.list="",d.dataset.content="\u2022",d.dataset.listMarker="",l.textContent=u,l.setAttribute("contenteditable","true"),t.replaceWith(l),r.prepend(d),o&&b(l))}}function N(n,t){let e=n.container,o=t.target,r;try{let u=o?.hasAttribute("contenteditable"),p=o?.tagName==="INPUT";if(r=window.getSelection()?.getRangeAt(0),!r||!u||p)throw""}catch{return}let i=n.getLineFromEditable(o),s=Object.keys(i?.dataset??{}),m=t?.inputType==="insertParagraph",d=t?.inputType==="insertText",l;if(t.type==="beforeinput"&&m&&i){t.preventDefault(),w(n,i);let u=(o.textContent??"").slice(0,r.startOffset),p=(o.textContent??"").slice(r.startOffset);if(r.startOffset===0&&s.length>0){M(o);return}i.dataset.todo===""&&(l="todo"),i.dataset.list===""&&(l="list"),i.dataset.todoChecked===""&&(l="todo");let c=n.getNextLine(i),f=n.createLine({text:p,modif:l});c?e.insertBefore(f,c):e?.appendChild(f),f.querySelector("[contenteditable]")?.focus(),o.textContent=u,e.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(t.type==="input"&&d){let p=(o?.textContent??"").replace("\u200B","");for(let[c,f]of Object.entries(n.mods))(p.startsWith(f+" ")||p.startsWith(f+"\xA0"))&&(l=c,S(n,o,l))}}function P(n,t){if(!t.key.includes("Arrow")||!window.getSelection()?.anchorNode)return;let e=t.target,o=n.getLineFromEditable(e),r=window?.getSelection()?.getRangeAt(0),i=r?.startContainer?.nodeValue?.length??0;if(!r||!o)return;let s=n.getPrevLine(o),m=n.getNextLine(o),d=Math.min(r?.endOffset,r?.startOffset)===0,l=Math.max(r?.endOffset,r?.startOffset)===i;if(t.key==="ArrowLeft"&&d&&s)return{line:o,dir:"up"};if(t.key==="ArrowRight"&&l&&m)return{line:o,dir:"down"};let u=!1,p=!1,c=r?.getBoundingClientRect(),f=o?.getBoundingClientRect();if(!f||!c||c.y===0?(u=!0,p=!0):(u=f.top-c.top+c.height>0,p=c.bottom+c.height-f.bottom>0),t.key==="ArrowUp"&&s&&u)return{line:o,dir:"up"};if(t.key==="ArrowDown"&&m&&p)return{line:o,dir:"down"}}function W(n){let t=n.lines,e,o=[-1,-1],r=-1,i=-1;function s(a){clearTimeout(e),e=window.setTimeout(()=>{a()},200)}function m(a){if(a||(a=n.getSelectedLines()),a.length===0)return;document.querySelector("#pocket-editor-mock-sel")?.remove();let h=document.createElement("pre");h.id="pocket-editor-mock-sel",h.textContent="mock-selection",h.setAttribute("contenteditable","true"),n.container.appendChild(h);let v=window.getSelection(),L=document.createRange(),y=h.childNodes[0].nodeValue?.length||0;L.setStart(h.childNodes[0],0),L.setEnd(h.childNodes[0],y),v?.removeAllRanges(),v?.addRange(L)}function d(a){let h=n.getLineFromEditable(a);return h?t.indexOf(h):-1}function l(){let a=t[r];a?.querySelector("[contenteditable]")&&b(a),r=-1,i=-1,o=[-1,-1],document.querySelector("#pocket-editor-mock-sel")?.remove(),n.container.removeEventListener("mousemove",E)}function u(a){a>i&&(o[1]=a),a<i&&(o[0]=a),a===i&&(o=[a,a])}function p(a){i=a,o=[a,a]}function c(a){t.forEach((h,v)=>{v>=a[0]&&v<=a[1]?h.setAttribute("data-selected",""):h.removeAttribute("data-selected")}),s(()=>m())}function f(a){r=i=a,o=[a,a]}function g(a){t=n.lines;let h=n.getSelectedLines(),v=a.key.match(/([x|c|v])/g),L=a.key==="Control"||a.key==="Meta",y=h.length>0,R=a.ctrlKey||a.metaKey;if(L||R&&v&&y)return;if(R&&a.key==="a"){window.getSelection()?.removeAllRanges(),r=i=0,o=[0,t.length-1],c(o),a.preventDefault();return}if(y){if(window.getSelection()?.removeAllRanges(),a.key==="Escape"||a.key==="Tab"){l(),c(o),a.preventDefault();return}if(a.key.includes("Arrow")){a.key.includes("Down")&&(r=Math.min(r+1,t.length-1)),a.key.includes("Up")&&(r=Math.max(0,r-1)),a.shiftKey&&u(r),a.shiftKey||p(r),c(o),a.preventDefault();return}a.code.match(/Shift|Alt|Control|Caps/)||(l(),w(n,h[h.length- -1]),n.removeLines(h),a.code==="Enter"&&a.preventDefault())}if(!a.shiftKey)return;let{line:j}=P(n,a)??{};if(j){let Z=t.indexOf(j);f(Z),c(o),window.getSelection()?.removeAllRanges()}}function E(a){let h=a.target,v=n.getSelectedLines();v.length>0&&window.getSelection()?.removeAllRanges();let L=h.getAttribute("aria-label")==="todo list checkbox",y=h.dataset.listMarker,R=!!h.getAttribute("contenteditable");if(L||y||R){if(r=d(h),r===i&&v.length===0)return;u(r),c(o)}}function x(a){let h=a.target,v=a.button===2,L=a.button===0,y=n.getSelectedLines().length===0;t=n.lines,v&&a.preventDefault(),!(!L||y)&&(l(),c(o),h.getAttribute("contenteditable")&&(f(d(h)),n.container.addEventListener("mousemove",E)))}function H(a){let h=a.composedPath(),v=n.getSelectedLines().length===0,L=!h.includes(n.container);v||(L&&(t=n.lines,l(),c(o)),n.container.removeEventListener("mousemove",E))}window.addEventListener("touchend",H),window.addEventListener("click",H),n.container.addEventListener("keydown",g),n.container.addEventListener("mousedown",x)}var K="\u200B";function Y(n,t){b(t),n.parentElement?.remove()}function X(n,t){let e=k(t),o=e.nodeType===3,r=e.nodeValue?.length||0,i=n?.textContent||"";e[o?"nodeValue":"textContent"]+=i;let s=window.getSelection(),m=document.createRange();m.setStart(e,o?r:0),m.setEnd(e,o?r:0),s?.removeAllRanges(),s?.addRange(m),n.parentElement.remove()}function _(n){let t="ontouchstart"in window||navigator.maxTouchPoints>0,e=navigator.userAgent.toLowerCase(),o=window.getSelection();function r(i){let s=i.target,m=n.getLineFromEditable(s),d="ontouchstart"in window||navigator.maxTouchPoints>0,l=!!s.getAttribute("contenteditable"),u=o?.getRangeAt(0)?.endOffset===0,p=i.inputType==="deleteContentBackward";if(i.type==="beforeinput"&&!p||!u||!l)return;if(i.preventDefault(),m&&w(n,m),Object.keys(m?.dataset??{}).length>0){let g=M(s);d&&g&&g.textContent===""&&(g.textContent=K,b(g));return}let f=n.getPrevLine(m);f&&(s.textContent===""&&Y(s,f),s.textContent!==""&&X(s,f))}if(n.container.addEventListener("beforeinput",r),e.includes("safari")&&!e.match(/chrome|chromium/)&&n.container.addEventListener("keydown",i=>{try{let s=o?.getRangeAt(0),m=i.key==="Backspace",d=s?.startOffset===0;m&&d&&r(i)}catch{}}),t){let i=!1;n.container.addEventListener("beforeinput",s=>{let m=s.target,d=s.inputType==="deleteContentBackward",l=m.textContent===K;d&&l&&(i=!0)}),n.container.addEventListener("keyup",s=>{let m=s.target;if(i){i=!1,r(s);return}m.textContent===""&&(m.textContent=K,b(m))})}}function B(n){let t=0;function e(){let i=document.createElement("p"),s=document.createElement("span");i.id="pocket-editor-mock-p",s.textContent="abcdefghijklmnopqrstuvwxyz0123456789",i?.appendChild(s),n.container.querySelector(".line [contenteditable]")?.appendChild(i),t=s.offsetWidth/36/2,i.remove()}function o(i,s){let m=window.getSelection(),d=-1,l=J(m,i),u=n.caret_x??l.offset,p=i?.querySelector("[contenteditable]"),c=k(p),f=document.createRange();f.setStart(c,0),f.setEnd(c,0);let g=0;for(let E=0;E<s.length-1;E++){try{f.setStart(c,E),f.setEnd(c,E)}catch{break}if(g=f.getBoundingClientRect().x-l.editable,g+t>=u){d=E;break}}return d}function r(i){let s=i?.querySelector("[contenteditable]");if(!s)return console.warn("Couldn't get string[], no contenteditable found"),[];let m=0,d=0,l=0,u=[""],p=(s.textContent??"").split(" "),c=k(s),f=document.createRange();f.setStart(c,0),f.setEnd(c,0);let g=navigator.userAgent.includes("AppleWebKit");l=d=f.getBoundingClientRect().y;for(let E of p){E=E+" ",m+=E.length;try{f.setStart(c,m),f.setEnd(c,m),d=f.getBoundingClientRect().y}catch{}g&&(u[0]+=E),d>l&&(g&&(u[0]=u[0].trimEnd()),u.unshift(""),l=d),g===!1&&(u[0]+=E)}return u.reverse(),u}n.container.addEventListener("pointerdown",function(){n.caret_x=void 0}),n.container.addEventListener("keydown",function(i){if(!i.key.includes("Arrow"))return;let s=i.key==="ArrowRight",m=i.key==="ArrowLeft",{line:d,dir:l}=P(n,i)??{},u=window.getSelection(),p=document.createRange(),c=0,f;if(m||s?n.caret_x=void 0:n.caret_x===void 0&&(n.caret_x=J(u,d).offset),!!d){if(t===0&&e(),l==="down"){let g=n.getNextLine(d)??d;f=k(g);let E=f.nodeValue?.length||0;if(!s){let x=r(g);c=o(g,x[0])??-1,c<0&&(c=E)}}if(l==="up"){let g=n.getPrevLine(d)??d;f=k(g);let E=f.nodeValue?.length||0;if(c=E,!m){let x=r(g),H=x[x.length-1].trimEnd(),a=o(g,H)??E;c=E-(H.length-a),a<0&&(c=E)}}try{p.setStart(f,c),p.setEnd(f,c),u?.removeAllRanges(),u?.addRange(p),u?.collapseToEnd(),i.preventDefault()}catch{console.warn("Cannot set caret")}}})}function J(n,t){let o=t?.querySelector("[contenteditable]")?.getBoundingClientRect().x??0,r=n?.getRangeAt(0)?.cloneRange()?.getBoundingClientRect().x??0;return{editable:o,range:r,offset:r-o}}async function q(n,t){let e=t.target;if((t.ctrlKey||t.metaKey)&&t.shiftKey&&t.code.includes("Digit")&&e){let i=parseInt(t.code.replace("Digit",""))-1,s=Object.keys(n.mods)[i];if(i===5){t.preventDefault(),M(e);return}s in n.mods&&s!=="todo-checked"&&(t.preventDefault(),S(n,e,s))}}var O=class{container;lines;wrapper;caret_x;mods={h1:"#",h2:"##",h3:"###",list:"-",todo:"[ ]","todo-checked":"[x]"};constructor(t,e){let o=document.createElement("div"),{text:r,defer:i,id:s}=e??{};if(this.wrapper=document.querySelector(t),this.container=o,this.lines=[],this.wrapper===null)throw`Pocket editor: selector "${t}" was not found`;s&&(o.id=s),o.dataset.pocketEditor="",typeof i=="number"?setTimeout(()=>this.init(r),i):i===!0?setTimeout(()=>this.init(r)):this.init(r)}init(t){let e=this;t?this.container.appendChild(C(this,t)):this.container.appendChild(this.createLine({text:""})),this.wrapper&&this.wrapper.appendChild(this.container),this.container.addEventListener("beforeinput",i=>N(e,i)),this.container.addEventListener("input",i=>N(e,i)),this.container.addEventListener("keydown",i=>q(e,i)),this.container.addEventListener("paste",i=>F(e,i)),this.container.addEventListener("copy",i=>V(e,i)),this.container.addEventListener("cut",i=>U(e,i)),W(e),B(e),_(e),I(e);let o=()=>{this.lines=Object.values(this.container.children)};new MutationObserver(o).observe(this.container,{childList:!0}),this.lines=Object.values(this.container.children)}get value(){return T(this.lines)}set value(t){Object.values(this.container.children).forEach(e=>e.remove()),this.container.appendChild(C(this,t))}oninput(t){let e=this;return this.container.addEventListener("cut",o),this.container.addEventListener("paste",o),this.container.addEventListener("input",o),this.container.addEventListener("beforeinput",o),()=>{this.container.removeEventListener("cut",o),this.container.removeEventListener("paste",o),this.container.removeEventListener("input",o),this.container.removeEventListener("beforeinput",o)};function o(r){r.type==="beforeinput"&&!r.inputType.match(/(deleteContentBackward|insertParagraph)/g)||t(e.value)}}addEventListener(t,e){return this.oninput(e)}getSelectedLines(){return this.lines.filter(t=>t.dataset.selected!==void 0)??[]}getPrevLine(t){return this.lines[this.lines.indexOf(t)-1]}getNextLine(t){return this.lines[this.lines.indexOf(t)+1]}getLineFromEditable(t){for(;t?.parentElement;){let e=t.parentElement;if(e.tagName==="DIV")return e;t=e}return null}removeLines(t){let e=this.createLine(),o=this.getPrevLine(t[0]);t.forEach(r=>r.remove()),o?this.insertAfter(e,o):this.container.prepend(e),b(e),this.container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}createLine(t){let e=document.createElement("div"),o=document.createElement("p"),r=t?.modif??"",i=this.mods;return o.setAttribute("contenteditable","true"),e.appendChild(o),typeof t?.text=="string"&&(o.textContent=t.text),r in i&&S(this,o,r,!1),e}insertAfter(t,e){e?.parentNode?.insertBefore(t,e.nextSibling)}},qt=O;globalThis.PocketEditor=O;})();
